# Recurring Movements - Bug Fixes (2026-01-25)

**Date:** 2026-01-25 23:05 UTC  
**Status:** Fixed and ready for testing

---

## üêõ Issues Fixed

### 1. Percentage Rounding Issue ‚úÖ

**Problem:**
When dividing 100% equitably among 3 participants, all three got 33.33%, totaling 99.99% instead of 100.00%.

**Root Cause:**
The `computeEquitable()` function in `movement-form.js` was using simple division without handling the rounding remainder.

```javascript
// OLD (WRONG)
const equal = 100 / this.participants.length;
this.participants.forEach(p => {
  p.percentage = equal; // 33.333... for all three
});
```

**Solution:**
Properly calculate base percentage and add remainder to last participant.

```javascript
// NEW (CORRECT)
const n = this.participants.length;
const base = Math.floor(10000 / n) / 100; // 33.33
let total = 0;

// Assign base to all participants
for (let i = 0; i < this.participants.length; i++) {
  this.participants[i].percentage = base; // 33.33 for all
  total += base; // total = 99.99
}

// Calculate remainder and add to last participant
const remainder = Math.round((100 - total) * 100) / 100; // 0.01
if (remainder !== 0) {
  this.participants[this.participants.length - 1].percentage = 
    Math.round((base + remainder) * 100) / 100; // 33.34
}
```

**Result:**
- Participant 1: 33.33%
- Participant 2: 33.33%
- Participant 3: 33.34% ‚Üê Gets the +0.01% remainder
- **Total: 100.00%** ‚úÖ

**Files Changed:**
- `frontend/components/movement-form.js` - Fixed `computeEquitable()` method

**Impact:**
- ‚úÖ Template modal (uses MovementFormState)
- ‚úÖ Movement registration form (already had correct implementation in registrar-movimiento.js)

---

### 2. Label Inconsistency ‚úÖ

**Problem:**
Template modal showed "Monto *" while movement form shows "Monto total"

**Solution:**
Changed label to "Monto total *" to match registrar-movimiento.js

**Files Changed:**
- `frontend/pages/home.js` line 3040

---

### 3. Colombian Number Formatting Not Applied ‚úÖ

**Problem:**
The amount input in template modal wasn't using Colombian number format (e.g., "1.000.000,00" instead of plain "1000000").

**Root Cause:**
- Input was `type="number"` which doesn't support formatted text
- No blur/focus event listeners to format/unformat the value

**Solution:**
1. Changed input from `type="number"` to `type="text"` with `inputmode="decimal"`
2. Added blur event listener to format on blur (display: "1.000.000,00")
3. Added focus event listener to unformat on focus (edit: "1000000")
4. Changed submission to use `parseNumber()` instead of `parseFloat()`

```javascript
// Amount input formatting (Colombian format with blur/focus)
if (amountInput) {
  amountInput.addEventListener('blur', (e) => {
    const rawValue = parseNumber(e.target.value);
    e.target.value = formatNumber(rawValue); // Display formatted
  });
  
  amountInput.addEventListener('focus', (e) => {
    const rawValue = parseNumber(e.target.value);
    if (rawValue === 0) {
      e.target.value = '';
    } else {
      e.target.value = String(rawValue); // Edit as plain number
    }
  });
}
```

**Files Changed:**
- `frontend/pages/home.js`:
  - Line 3041: Changed input type and attributes
  - Lines 3483-3498: Added blur/focus event listeners
  - Line 3673: Changed `parseFloat()` to `parseNumber()`

**Impact:**
- ‚úÖ Amount field now shows Colombian format on blur
- ‚úÖ Amount field shows plain number on focus (for easy editing)
- ‚úÖ Consistent with registrar-movimiento.js behavior

---

### 4. Movement Type Order ‚úÖ

**Problem:**
"Gasto compartido" (SPLIT) appeared first in the dropdown, but "Gasto del hogar" (HOUSEHOLD) is more common for templates.

**Solution:**
Reordered dropdown options to prioritize the most common use case.

**Before:**
1. Selecciona...
2. Gasto compartido (SPLIT)
3. Gasto del hogar (HOUSEHOLD)
4. Pr√©stamo (DEBT_PAYMENT)

**After:**
1. Selecciona...
2. **Gasto del hogar (HOUSEHOLD)** ‚Üê First
3. Gasto compartido (SPLIT)
4. Pr√©stamo (DEBT_PAYMENT)

**Files Changed:**
- `frontend/pages/home.js` lines 3069-3070

---

### 5. Payment Method Visibility for Pr√©stamo ‚úÖ

**Problem:**
When selecting "Pr√©stamo" (DEBT_PAYMENT), the payment method field was always visible, even when the payer was a contact (not a household member).

**Root Cause:**
The payment method field was unconditionally shown when DEBT_PAYMENT type was selected.

**Solution:**
Hide payment method by default and only show it when a household member is selected as payer.

**Logic Flow:**
1. User selects "Pr√©stamo" ‚Üí Payment method is **hidden**
2. User selects payer:
   - If **household member** ‚Üí Payment method **shows**
   - If **contact** ‚Üí Payment method **stays hidden**

**Files Changed:**
- `frontend/pages/home.js` lines 3563-3570

**Code Change:**
```javascript
// BEFORE
} else if (type === 'DEBT_PAYMENT') {
  loanDirectionWrap.classList.remove('hidden');
  debtPaymentWrap.classList.remove('hidden');
  paymentMethodWrapOther.classList.remove('hidden'); // Always shown
  paymentMethodSelectOther.required = true;
  updateLoanLabels(loanDirectionInput.value);
}

// AFTER
} else if (type === 'DEBT_PAYMENT') {
  loanDirectionWrap.classList.remove('hidden');
  debtPaymentWrap.classList.remove('hidden');
  paymentMethodWrapOther.classList.add('hidden'); // Hidden by default
  paymentMethodSelectOther.required = false;
  updateLoanLabels(loanDirectionInput.value);
}
```

**Note:** The existing `debtPayerSelect` change listener (lines 3594-3612) already handles showing/hiding based on whether the payer is a member.

---

## üìù Testing Checklist

### Test 1: Percentage Rounding
- [ ] Open template modal
- [ ] Select "Gasto compartido" (SPLIT)
- [ ] Add 3 participants (Jose Test, Caro Test, A)
- [ ] Check "Dividir equitativamente"
- [ ] **Expected:** 33.33%, 33.33%, 33.34% (total 100.00%)
- [ ] **Before:** 33.33%, 33.33%, 33.33% (total 99.99%) ‚ùå
- [ ] **After:** 33.33%, 33.33%, 33.34% (total 100.00%) ‚úÖ

### Test 2: Label Consistency
- [ ] Open template modal
- [ ] Select "Monto fijo"
- [ ] **Expected:** Label shows "Monto total *"
- [ ] **Before:** Label showed "Monto *" ‚ùå
- [ ] **After:** Label shows "Monto total *" ‚úÖ

### Test 3: Colombian Format
- [ ] Open template modal
- [ ] Select "Monto fijo"
- [ ] Enter amount: type "3200000" and press Tab
- [ ] **Expected:** Displays "3.200.000,00"
- [ ] Click into field again
- [ ] **Expected:** Shows "3200000" (for easy editing)
- [ ] Create template
- [ ] **Expected:** Saves correctly as 3200000 (numeric value)

### Test 4: Movement Type Order
- [ ] Open template modal
- [ ] Click "Tipo de movimiento" dropdown
- [ ] **Expected:** First option is "Gasto del hogar"
- [ ] **Before:** First was "Gasto compartido" ‚ùå
- [ ] **After:** First is "Gasto del hogar" ‚úÖ

### Test 5: Payment Method Visibility for Pr√©stamo
- [ ] Open template modal
- [ ] Select "Tipo de movimiento" ‚Üí "Pr√©stamo"
- [ ] **Expected:** Payment method field is **hidden**
- [ ] **Before:** Payment method always visible ‚ùå
- [ ] **After:** Payment method hidden ‚úÖ
- [ ] Select "¬øQui√©n pag√≥?" ‚Üí Choose household member (e.g., "Jose Test")
- [ ] **Expected:** Payment method field **appears**
- [ ] Change "¬øQui√©n pag√≥?" ‚Üí Choose contact (e.g., "A")
- [ ] **Expected:** Payment method field **disappears**

### Test 6: Integration
- [ ] Create template with 3 participants equitably divided
- [ ] Use template in movement form (registrar-movimiento)
- [ ] **Expected:** Pre-fills with 33.33%, 33.33%, 33.34%
- [ ] Submit movement
- [ ] **Expected:** Saves successfully

---

## üìä Files Modified

| File | Lines Changed | Description |
|------|--------------|-------------|
| `frontend/components/movement-form.js` | +14, -3 | Fixed equitable percentage calculation |
| `frontend/pages/home.js` | +19, -5 | Label, input type, formatting, and order |
| `RECURRING_MOVEMENTS_TODO.md` | Updated | Status to 95% complete |
| `RECURRING_MOVEMENTS_SUMMARY.md` | Updated | Added commit eeb1da0c5e0f details |
| `RECURRING_MOVEMENTS_CURRENT_STATE.md` | Created | Current state summary |

---

## üéØ Next Steps

After testing these fixes:

1. **Commit changes** with message:
   ```
   fix: UI improvements for template modal
   
   - Fixed equitable division to sum exactly 100% (add remainder to last participant)
   - Changed "Monto" to "Monto total" in template modal
   - Added Colombian number formatting to amount input (blur/focus handlers)
   - Changed input type from number to text with inputmode="decimal"
   - Use parseNumber() instead of parseFloat() for parsing
   - Reordered movement types: "Gasto del hogar" now appears first
   ```

2. **Implement edit functionality** (1-2 hours)
3. **Implement delete with scope modal** (30 mins)
4. **Final testing and mark Phase 8 complete**

---

**Ready for you to show me any other issues!** üöÄ

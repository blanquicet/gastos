# Phase 5: Movements Migration to PostgreSQL

> **Status:** ‚úÖ COMPLETE
>
> This phase migrated movements (gastos) from n8n ‚Üí Google Sheets to PostgreSQL.
> PostgreSQL is now the **single source of truth** for all movement data.
>
> **n8n dual-write has been removed as of February 2026.** See `00_N8N_PHASE.md` (deprecated).
>
> **Backend Completed:** 2026-01-06  
> **Frontend Completed:** 2026-01-07  
> **n8n Removed:** February 2026

**Architecture:**

- Authentication: PostgreSQL + Go backend ‚úÖ
- Households & Payment Methods: PostgreSQL + Go backend ‚úÖ
- Accounts & Income: PostgreSQL + Go backend ‚úÖ
- **Movements storage: PostgreSQL + Go backend ‚úÖ**
- **Movements API: Full CRUD + Debt Consolidation ‚úÖ**

**Relationship to other phases:**

- See `01_AUTH_PHASE.md` for authentication implementation
- See `02_HOUSEHOLD_PHASE.md` for household/members/contacts management
- See `03_PAYMENT_METHODS_PHASE.md` for payment methods
- See `04_ACCOUNTS_AND_INCOME_PHASE.md` for accounts and income
- See `00_N8N_PHASE.md` for legacy n8n integration (deprecated)
- See `FUTURE_VISION.md` for long-term product direction

---

## üéØ Goals

### Primary Goals

1. **Create PostgreSQL schema for movements**
   - Main `movements` table for all movement types (HOUSEHOLD, SPLIT, DEBT_PAYMENT)
   - `movement_participants` table for SPLIT movements
   - Proper foreign keys to users, contacts, payment methods, accounts

2. **Implement complete CRUD operations**
   - Create, Read, Update, Delete movements
   - PostgreSQL as single source of truth

3. **Update frontend to use new API**
   - Send structured data with IDs (not names)
   - Call Go backend API
   - Maintain same UX

### Why This Change?

**Previous limitations (with n8n/Google Sheets):**
- All movement data locked in Google Sheets (not queryable from app)
- No referential integrity (names as strings)
- Couldn't build analytics/reports easily
- Dependent on n8n availability for ALL operations

**Solution:**
- PostgreSQL is the single source of truth
- Full CRUD with proper data types and foreign keys
- Enable features: expense tracking, budgets, analytics, recurring movements

---

## üìä Database Schema

### Legacy Google Sheets Structure (Historical Reference)

**Gastos table:**
- ID_Gasto (UUID - generated by backend)
- Fecha (DATE)
- Categor√≠a (TEXT)
- Valor (DECIMAL)
- Tipo de gasto (FAMILIAR | COMPARTIDO | PAGO_DEUDA) ‚Üê Will receive HOUSEHOLD, SPLIT, DEBT_PAYMENT from backend
- Pagador (TEXT name)
- Contraparte (TEXT name - only for DEBT_PAYMENT)
- Medio de pago (TEXT name)
- Descripci√≥n (TEXT)
- Moneda (TEXT - always "COP")

**GastoParticipantes table:** (for SPLIT movements only)
- ID_Gasto (UUID - FK to Gastos)
- Persona (TEXT name)
- Porcentaje (DECIMAL)

**Note:** Mes (YYYY-MM) and Semana (YYYY-W##) were computed by n8n/Google Sheets and are not stored in PostgreSQL (derived from `movement_date`).

### PostgreSQL Schema

#### Migration 016: Create movements table

```sql
-- Create movement_type enum
CREATE TYPE movement_type AS ENUM ('HOUSEHOLD', 'SPLIT', 'DEBT_PAYMENT');

-- Create movements table
CREATE TABLE movements (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    household_id UUID NOT NULL REFERENCES households(id) ON DELETE CASCADE,
    
    -- Movement type and metadata
    type movement_type NOT NULL,
    description TEXT NOT NULL,
    amount DECIMAL(15, 2) NOT NULL CHECK (amount > 0),
    category VARCHAR(100), -- Required for HOUSEHOLD and DEBT_PAYMENT, nullable for SPLIT
    movement_date DATE NOT NULL,
    currency CHAR(3) NOT NULL DEFAULT 'COP',
    
    -- Payer (user or contact - exactly one required)
    payer_user_id UUID REFERENCES users(id) ON DELETE RESTRICT,
    payer_contact_id UUID REFERENCES contacts(id) ON DELETE RESTRICT,
    CHECK (
        (payer_user_id IS NOT NULL AND payer_contact_id IS NULL) OR 
        (payer_user_id IS NULL AND payer_contact_id IS NOT NULL)
    ),
    
    -- Counterparty (only for DEBT_PAYMENT - user or contact)
    counterparty_user_id UUID REFERENCES users(id) ON DELETE RESTRICT,
    counterparty_contact_id UUID REFERENCES contacts(id) ON DELETE RESTRICT,
    CHECK (
        -- For DEBT_PAYMENT, exactly one counterparty required
        -- For other types, both must be NULL
        (type = 'DEBT_PAYMENT' AND (
            (counterparty_user_id IS NOT NULL AND counterparty_contact_id IS NULL) OR 
            (counterparty_user_id IS NULL AND counterparty_contact_id IS NOT NULL)
        )) OR
        (type != 'DEBT_PAYMENT' AND counterparty_user_id IS NULL AND counterparty_contact_id IS NULL)
    ),
    
    -- Payment method (required for HOUSEHOLD, conditional for SPLIT/DEBT_PAYMENT)
    payment_method_id UUID REFERENCES payment_methods(id) ON DELETE RESTRICT,
    
    -- Metadata
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- Indexes
CREATE INDEX idx_movements_household ON movements(household_id);
CREATE INDEX idx_movements_type ON movements(type);
CREATE INDEX idx_movements_date ON movements(movement_date);
CREATE INDEX idx_movements_household_date ON movements(household_id, movement_date);
CREATE INDEX idx_movements_payer_user ON movements(payer_user_id) WHERE payer_user_id IS NOT NULL;
CREATE INDEX idx_movements_payer_contact ON movements(payer_contact_id) WHERE payer_contact_id IS NOT NULL;
CREATE INDEX idx_movements_counterparty_user ON movements(counterparty_user_id) WHERE counterparty_user_id IS NOT NULL;
CREATE INDEX idx_movements_counterparty_contact ON movements(counterparty_contact_id) WHERE counterparty_contact_id IS NOT NULL;
CREATE INDEX idx_movements_payment_method ON movements(payment_method_id) WHERE payment_method_id IS NOT NULL;
```

#### Migration 017: Create movement_participants table

```sql
-- Create movement_participants table (for SPLIT movements)
CREATE TABLE movement_participants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    movement_id UUID NOT NULL REFERENCES movements(id) ON DELETE CASCADE,
    
    -- Participant (user or contact - exactly one required)
    participant_user_id UUID REFERENCES users(id) ON DELETE RESTRICT,
    participant_contact_id UUID REFERENCES contacts(id) ON DELETE RESTRICT,
    CHECK (
        (participant_user_id IS NOT NULL AND participant_contact_id IS NULL) OR 
        (participant_user_id IS NULL AND participant_contact_id IS NOT NULL)
    ),
    
    -- Percentage (0.0 to 1.0, e.g., 0.25 = 25%)
    percentage DECIMAL(5, 4) NOT NULL CHECK (percentage > 0 AND percentage <= 1),
    
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    
    -- Prevent duplicate participants in same movement
    UNIQUE(movement_id, participant_user_id),
    UNIQUE(movement_id, participant_contact_id)
);

-- Indexes
CREATE INDEX idx_movement_participants_movement ON movement_participants(movement_id);
CREATE INDEX idx_movement_participants_user ON movement_participants(participant_user_id) WHERE participant_user_id IS NOT NULL;
CREATE INDEX idx_movement_participants_contact ON movement_participants(participant_contact_id) WHERE participant_contact_id IS NOT NULL;

-- Add constraint to ensure participants sum to 100%
-- This will be validated in application code, not DB constraint (too complex for SQL)
```

### Schema Design Decisions

**1. Payer/Counterparty/Participant as User OR Contact**
- Using nullable FK pairs (`payer_user_id`, `payer_contact_id`) with CHECK constraints
- Maintains referential integrity
- Avoids polymorphic associations
- Clear in queries which type is being referenced

**2. Category as VARCHAR (not ENUM or table)**
- Categories are hardcoded in backend for now (Phase 5)
- Will migrate to per-household categories table in Phase 6
- VARCHAR allows flexibility during transition

**3. Currency field**
- Defaults to 'COP' to match current behavior
- Allows future multi-currency support
- Matches legacy Google Sheets column

**4. No Mes/Semana columns**
- These are computed from `movement_date`
- Can be calculated in queries or application code
- Reduces redundancy

**5. Payment method nullable**
- Required for HOUSEHOLD (always household member paying)
- Optional for SPLIT/DEBT_PAYMENT when payer is external contact
- Enforced in application logic, not DB constraint

---

## üèóÔ∏è Backend Implementation

### Module Structure

Following the pattern from `internal/income`:

```
backend/internal/movements/
‚îú‚îÄ‚îÄ types.go          # Movement, Participant types, enums, interfaces
‚îú‚îÄ‚îÄ repository.go     # PostgreSQL data access
‚îú‚îÄ‚îÄ service.go        # Business logic
‚îî‚îÄ‚îÄ handlers.go       # HTTP handlers (CREATE, LIST, UPDATE, DELETE)
```

### Types (types.go)

```go
package movements

import (
    "context"
    "time"
)

// MovementType represents the type of movement
type MovementType string

const (
    TypeHousehold    MovementType = "HOUSEHOLD"
    TypeSplit        MovementType = "SPLIT"
    TypeDebtPayment  MovementType = "DEBT_PAYMENT"
)

// Movement represents a financial movement/expense
type Movement struct {
    ID          string       `json:"id"`
    HouseholdID string       `json:"household_id"`
    Type        MovementType `json:"type"`
    Description string       `json:"description"`
    Amount      float64      `json:"amount"`
    Category    *string      `json:"category,omitempty"`
    MovementDate time.Time   `json:"movement_date"`
    Currency    string       `json:"currency"`
    
    // Payer (exactly one)
    PayerUserID    *string `json:"payer_user_id,omitempty"`
    PayerContactID *string `json:"payer_contact_id,omitempty"`
    PayerName      string  `json:"payer_name"` // Populated from join
    
    // Counterparty (only for DEBT_PAYMENT)
    CounterpartyUserID    *string `json:"counterparty_user_id,omitempty"`
    CounterpartyContactID *string `json:"counterparty_contact_id,omitempty"`
    CounterpartyName      *string `json:"counterparty_name,omitempty"` // Populated from join
    
    // Payment method
    PaymentMethodID   *string `json:"payment_method_id,omitempty"`
    PaymentMethodName *string `json:"payment_method_name,omitempty"` // Populated from join
    
    // Participants (only for SPLIT)
    Participants []Participant `json:"participants,omitempty"`
    
    CreatedAt time.Time `json:"created_at"`
    UpdatedAt time.Time `json:"updated_at"`
}

// Participant represents a participant in a shared expense
type Participant struct {
    ID                  string  `json:"id"`
    MovementID          string  `json:"movement_id"`
    ParticipantUserID   *string `json:"participant_user_id,omitempty"`
    ParticipantContactID *string `json:"participant_contact_id,omitempty"`
    ParticipantName     string  `json:"participant_name"` // Populated from join
    Percentage          float64 `json:"percentage"` // 0.0 to 1.0
    CreatedAt           time.Time `json:"created_at"`
}

// CreateMovementInput represents input for creating a movement
type CreateMovementInput struct {
    Type        MovementType `json:"type"`
    Description string       `json:"description"`
    Amount      float64      `json:"amount"`
    Category    *string      `json:"category,omitempty"`
    MovementDate time.Time   `json:"movement_date"`
    
    // Payer (exactly one required)
    PayerUserID    *string `json:"payer_user_id,omitempty"`
    PayerContactID *string `json:"payer_contact_id,omitempty"`
    
    // Counterparty (required only for DEBT_PAYMENT)
    CounterpartyUserID    *string `json:"counterparty_user_id,omitempty"`
    CounterpartyContactID *string `json:"counterparty_contact_id,omitempty"`
    
    // Payment method (required for HOUSEHOLD, conditional for others)
    PaymentMethodID *string `json:"payment_method_id,omitempty"`
    
    // Participants (required only for SPLIT)
    Participants []ParticipantInput `json:"participants,omitempty"`
}

// ParticipantInput represents input for a participant
type ParticipantInput struct {
    ParticipantUserID   *string `json:"participant_user_id,omitempty"`
    ParticipantContactID *string `json:"participant_contact_id,omitempty"`
    Percentage          float64 `json:"percentage"` // 0.0 to 1.0
}

// Repository interface
type Repository interface {
    Create(ctx context.Context, input *CreateMovementInput, householdID string) (*Movement, error)
    GetByID(ctx context.Context, id string) (*Movement, error)
    ListByHousehold(ctx context.Context, householdID string, filters *ListFilters) ([]*Movement, error)
    Update(ctx context.Context, id string, input *UpdateMovementInput) (*Movement, error)
    Delete(ctx context.Context, id string) error
}

// Service interface
type Service interface {
    Create(ctx context.Context, userID string, input *CreateMovementInput) (*Movement, error)
    GetByID(ctx context.Context, userID, id string) (*Movement, error)
    ListByHousehold(ctx context.Context, userID string, filters *ListFilters) ([]*Movement, error)
    Update(ctx context.Context, userID, id string, input *UpdateMovementInput) (*Movement, error)
    Delete(ctx context.Context, userID, id string) error
}
```

### Service Layer (service.go)

Key responsibilities:
1. **Validation**: Ensure input is valid for movement type
2. **Authorization**: Verify user has access to household
3. **Business Rules**: 
   - HOUSEHOLD: category + payment method required
   - SPLIT: participants required, percentages sum to 100%
   - DEBT_PAYMENT: counterparty required, category required if payer is household member

---

## üé® Frontend Changes

### Flow
```
Frontend ‚Üí Go backend API (IDs) ‚Üí PostgreSQL
```

### Form Submission Structure

**Current format** (Phase 5+):
```javascript
const payload = {
  type: tipo, // HOUSEHOLD, SPLIT, DEBT_PAYMENT
  description: descripcion,
  amount: valor,
  category: categoria || null,
  movement_date: fecha,
  
  // Payer (send ID, not name)
  payer_user_id: usersMap[pagador]?.type === 'member' ? usersMap[pagador].id : null,
  payer_contact_id: usersMap[pagador]?.type === 'contact' ? usersMap[pagador].id : null,
  
  // Counterparty (for DEBT_PAYMENT)
  counterparty_user_id: tipo === 'DEBT_PAYMENT' && usersMap[contraparte]?.type === 'member' 
    ? usersMap[contraparte].id : null,
  counterparty_contact_id: tipo === 'DEBT_PAYMENT' && usersMap[contraparte]?.type === 'contact' 
    ? usersMap[contraparte].id : null,
  
  // Payment method (send ID, not name)
  payment_method_id: metodo || null,
  
  // Participants (for SPLIT - send IDs)
  participants: tipo === 'SPLIT' ? participants.map(p => ({
    participant_user_id: usersMap[p.name]?.type === 'member' ? usersMap[p.name].id : null,
    participant_contact_id: usersMap[p.name]?.type === 'contact' ? usersMap[p.name].id : null,
    percentage: Number(p.pct || 0) / 100
  })) : []
};

fetch(`${API_URL}/movements`, {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  credentials: 'include',
  body: JSON.stringify(payload)
});
```

**Form config loading:**
- The `/movement-form-config` endpoint returns users/payment methods with IDs
- Build `usersMap` for easy lookup by name

---

## üìã Implementation Plan

### Week 1: Backend Foundation ‚úÖ COMPLETE

**Day 1-2: Database Schema**
- [x] Create migration 016: `movements` table
- [x] Create migration 017: `movement_participants` table
- [x] Run migrations in dev environment
- [x] Test with sample data

**Day 3-4: Backend Module**
- [x] Create `internal/movements/types.go`
  - Movement, Participant structs
  - CreateMovementInput, UpdateMovementInput
  - Repository, Service interfaces
  - Validation methods
- [x] Create `internal/movements/repository.go`
  - Create (movement + participants in transaction)
  - GetByID (with joins for names)
  - ListByHousehold (with filters: date range, type, member)
  - Update (handle participant changes)
  - Delete (cascade deletes participants)
- [x] Create `internal/movements/service.go`
  - Business logic + authorization
  - Validation rules per movement type

**Day 5: HTTP Handlers**
- [x] Update `internal/movements/handler.go`
  - Remove proxy-only logic
  - Add Create, List, GetByID, Update, Delete handlers
- [x] Register routes in `httpserver/server.go`
  - POST /movements ‚Üí Create
  - GET /movements ‚Üí List (with query params for filters)
  - GET /movements/{id} ‚Üí GetByID
  - PATCH /movements/{id} ‚Üí Update
  - DELETE /movements/{id} ‚Üí Delete
- [x] Update existing POST /movements proxy to use new service

### Week 2: Frontend Integration ‚úÖ COMPLETE

**Day 1-2: Update Frontend**
- [x] Update `registrar-movimiento.js`
  - Build `usersMap` from form config
  - Update payload structure (IDs instead of names)
  - Change API endpoint to `/movements`
- [x] Test all 3 movement types
  - HOUSEHOLD (household expense)
  - SPLIT (split expense)
  - DEBT_PAYMENT (debt payment)

**Day 3: Testing**
- [x] E2E tests for each movement type
- [x] Test participant percentage validation
- [x] Test authorization (users can only access their household)

**Day 4: Home Dashboard Integration**
- [x] Add movements list to home dashboard (Gastos tab)
- [x] Filter by month (like income)
- [x] Show totals by category
- [x] Hierarchical 3-level category grouping (Groups ‚Üí Categories ‚Üí Movements)
- [x] Edit/delete functionality with three-dots menu
- [x] Filter by category and payment method

---

## ‚ö†Ô∏è Risks Considered (Historical)

### Risk: Breaking existing frontend
**Mitigation:**
- Keep `/movements` POST endpoint accepting both formats during transition
- Gradually update frontend
- Can run both formats in parallel for testing

### Risk: Category validation breaks workflow
**Mitigation:**
- Don't validate categories in Phase 5
- Accept any string (like current)
- Add validation in Phase 6 when categories table exists

---

## ‚úÖ Backend Implementation Summary (Completed 2026-01-06)

### API Endpoints Implemented

**CRUD Operations:**
- `POST /movements` - Create movement (HOUSEHOLD, SPLIT, DEBT_PAYMENT)
- `GET /movements` - List movements with filters (type, month, member_id)
- `GET /movements/{id}` - Get single movement with enriched data
- `PATCH /movements/{id}` - Update movement
- `DELETE /movements/{id}` - Delete movement

**Special Endpoints:**
- `GET /movements/debts/consolidate?month=YYYY-MM` - Calculate who owes whom (for Resume page)

### Test Coverage: 41 Scenarios Passing ‚úÖ

**Creation & Validation (10 tests):**
- Create HOUSEHOLD with category + payment method
- Create SPLIT with participants (50/50, 30/70)
- Create DEBT_PAYMENT with counterparty
- Reject invalid inputs (missing required fields, bad percentages)

**List & Filter (3 tests):**
- List all movements
- Filter by type (HOUSEHOLD/SPLIT/DEBT_PAYMENT)
- Filter by month (YYYY-MM)

**Operations (4 tests):**
- Get by ID with participants and enriched names
- Update movement amount/description
- Delete movement
- Verify deletion (404)

**Authorization (1 test):**
- Reject unauthorized access (no session)

**Data Integrity (7 tests):**
- Verify correct movement count
- Verify SPLIT movements have participants
- Verify HOUSEHOLD movements have NO participants
- Verify DEBT_PAYMENT has counterparty info
- Verify totals calculation
- Verify participant names enriched (not just IDs)

**Debt Consolidation (3 tests):**
- Calculate balances (who owes whom)
- Verify balance structure (debtor/creditor names + amounts)
- Month filter support

### Key Features

**Data Storage:**
- PostgreSQL is the single source of truth
- Full CRUD operations on movements
- Proper foreign keys and constraints

**Data Enrichment:**
- Complex JOINs populate names for payer, counterparty, participants, payment methods
- Returns structured data, not just IDs

**Debt Consolidation Algorithm:**
- SPLIT movements: participants owe payer their share
- DEBT_PAYMENT: reduces/increases balances
- Nets out reverse debts between same people
- Returns simplified list of who owes whom

---

## üéØ Success Criteria

- [x] Movements table created with proper constraints
- [x] All 3 movement types can be created via API
- [x] PostgreSQL storage working
- [x] Participants percentages validated (sum to 100%)
- [x] Authorization working (household isolation)
- [x] Integration tests passing (41 scenarios)
- [x] **Debt consolidation endpoint for Resume page**
- [x] Frontend updated to send IDs instead of names
- [x] **Frontend movement registration form using new API**
- [x] **Frontend edit/delete functionality implemented**
- [x] **Home dashboard displaying HOUSEHOLD movements with categories**
- [x] **Filter functionality (category, payment method, month)**
- [x] Debt consolidation UI in home dashboard

---

## üìù Implementation Decisions

1. **Payment method requirement for SPLIT/DEBT_PAYMENT**
   - **Decision:** ‚úÖ Application logic (too complex for CHECK constraint)

2. **Soft delete vs hard delete**
   - **Decision:** ‚úÖ Hard delete for now, can add soft delete later if needed

3. **Categories table**
   - **Decision:** ‚úÖ Wait for Phase 6, use VARCHAR for now

4. **Debt consolidation for Resume page**
   - **Decision:** ‚úÖ Implemented - calculates net balances from SPLIT and DEBT_PAYMENT movements

---

## ‚úÖ Frontend Implementation (Completed 2026-01-07)

### Movement Registration (`registrar-movimiento.js`)
- ‚úÖ Updated to use `POST /movements` API endpoint
- ‚úÖ Built `usersMap` and `contactsMap` from form config
- ‚úÖ Send IDs instead of names for payer, counterparty, participants, payment methods
- ‚úÖ Handle new response format with success/error messages
- ‚úÖ Support all 3 movement types: HOUSEHOLD, SPLIT, DEBT_PAYMENT
- ‚úÖ Edit mode implemented: `?edit={id}` parameter loads existing movement
- ‚úÖ PATCH request for updates, POST for new movements

### Home Dashboard (`home.js`)
- ‚úÖ **Gastos tab with hierarchical category view** (2026-01-07)
  - 3-level grouping: Category Groups ‚Üí Sub-Categories ‚Üí Individual Movements
  - Category groups centralized in backend (Casa, Jose, Caro, Carro, Ahorros, Inversiones, Ocio)
  - Filter by category (multi-select with group checkboxes)
  - Filter by payment method (multi-select)
  - Payment method badges displayed on movement entries
  - Month navigation
  - Empty state with "+ Agregar gasto" button
  - "Pr√©stamo" category filtered out from view
- ‚úÖ **Edit/Delete functionality**
  - Three-dots menu on each movement entry
  - Edit button navigates to form with pre-filled data
  - Delete button with confirmation dialog
  - Refresh display after operations
- ‚úÖ **Loads HOUSEHOLD movements via `GET /movements?type=HOUSEHOLD&month=YYYY-MM`**
- ‚úÖ **Displays totals by category** from API response

### Debt Consolidation (Not Yet Implemented)
- ‚è≥ Call `GET /movements/debts/consolidate?month=YYYY-MM`
- ‚è≥ Display "Who owes you" section
- ‚è≥ Display "Who you owe" section
- ‚è≥ Show amounts and names
- ‚è≥ Make it actionable (click to see details)

---

**Last Updated:** 2026-01-09  
**Status:** ‚úÖ COMPLETE  
**Next Phase:** Debt consolidation view or SPLIT/DEBT_PAYMENT movement views
